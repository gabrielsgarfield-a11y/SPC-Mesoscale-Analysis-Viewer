<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>MesoViz — SPC Mesoanalysis Viewer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
:root{--bg:#070b14;--pn:#0d1321;--bd:#162033;--inp:#131b2e;--tx:#d6dde8;--txd:#6b7d9a;--txm:#3b4d6a;--ac:#4a9eff;--acd:rgba(74,158,255,.15);--am:#f0a830;--rd:#e55050;--gn:#3dd68c}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--tx);height:100vh;width:100vw;overflow:hidden}
#map{position:absolute;inset:0;z-index:1;background:var(--bg)}
.topbar{position:absolute;top:0;left:0;right:0;z-index:1000;background:rgba(7,11,20,.94);backdrop-filter:blur(16px);border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px;padding:8px 14px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:7px;margin-right:6px}
.brand-mark{width:26px;height:26px;border-radius:5px;background:linear-gradient(135deg,#4a9eff,#7c5cfc);display:grid;place-items:center;font-size:12px;font-weight:800;color:#fff;box-shadow:0 0 10px rgba(74,158,255,.35)}
.brand-name{font-size:14px;font-weight:700;letter-spacing:.5px}
.sep{width:1px;height:28px;background:var(--bd);flex-shrink:0}
.ctrl{display:flex;align-items:center;gap:5px}
.ctrl-label{font-size:10px;color:var(--txm);text-transform:uppercase;letter-spacing:1px}
input[type="date"]{font-family:inherit;font-size:12px;background:var(--inp);color:var(--tx);border:1px solid var(--bd);border-radius:5px;padding:5px 8px;outline:none}
input[type="date"]:focus{border-color:var(--ac);box-shadow:0 0 0 2px var(--acd)}
.btn{font-family:inherit;font-size:11px;font-weight:600;padding:5px 12px;border-radius:5px;border:1px solid var(--bd);background:var(--inp);color:var(--tx);cursor:pointer;transition:.15s;white-space:nowrap}
.btn:hover{border-color:var(--ac);background:var(--acd)}
.btn-ac{background:var(--ac);border-color:var(--ac);color:#fff;box-shadow:0 0 10px rgba(74,158,255,.3)}
.btn-ac:hover{background:#3888e8}
.btn-i{padding:5px 7px;font-size:14px;line-height:1}
.hnav{display:flex;align-items:center;gap:2px}
.hval{font-size:17px;font-weight:700;color:var(--am);min-width:42px;text-align:center;text-shadow:0 0 8px rgba(240,168,48,.4)}
.sidebar{position:absolute;top:50px;right:0;bottom:0;width:270px;z-index:999;background:rgba(10,16,28,.96);backdrop-filter:blur(14px);border-left:1px solid var(--bd);overflow-y:auto;transition:transform .3s}
.sidebar.hide{transform:translateX(270px)}
.sbt{position:absolute;top:58px;right:270px;z-index:999;background:var(--pn);border:1px solid var(--bd);border-right:none;border-radius:5px 0 0 5px;padding:7px 5px;cursor:pointer;color:var(--txd);font-size:13px;transition:right .3s}
.sbt.shifted{right:0}
.sec{padding:11px 13px;border-bottom:1px solid var(--bd)}
.sh{font-size:9px;color:var(--txm);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.sd{width:5px;height:5px;border-radius:50%;background:var(--ac);box-shadow:0 0 5px var(--acd)}
.row{display:flex;align-items:center;justify-content:space-between;padding:3px 0}
.rl{font-size:11px;color:var(--txd)}
.sw{width:34px;height:18px;border-radius:9px;background:var(--inp);border:1px solid var(--bd);position:relative;cursor:pointer;transition:.2s}
.sw.on{background:var(--ac);border-color:var(--ac)}
.sw::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:.2s}
.sw.on::after{left:17px}
.sr{display:flex;align-items:center;gap:6px;margin:5px 0}
.sl{font-size:10px;color:var(--txd);min-width:52px}
.sv{font-size:10px;color:var(--ac);min-width:28px;text-align:right}
input[type="range"]{flex:1;-webkit-appearance:none;height:3px;border-radius:2px;background:var(--bd);outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--ac);cursor:pointer;box-shadow:0 0 4px var(--acd)}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.cat{grid-column:1/-1;font-size:10px;font-weight:600;color:var(--txd);padding:7px 0 3px}
.cat:first-child{padding-top:0}
.pb{font-family:inherit;font-size:10px;padding:5px 3px;border-radius:3px;border:1px solid transparent;background:var(--inp);color:var(--txd);cursor:pointer;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:.12s}
.pb:hover{border-color:var(--ac);color:var(--tx)}
.pb.on{background:var(--acd);border-color:var(--ac);color:var(--ac);font-weight:600}
.status{position:absolute;bottom:0;left:0;right:0;z-index:1000;background:rgba(7,11,20,.9);backdrop-filter:blur(8px);border-top:1px solid var(--bd);padding:5px 13px;display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--txm)}
.si{display:flex;align-items:center;gap:5px}
.dot{width:5px;height:5px;border-radius:50%;background:var(--gn);animation:pls 2s infinite}
.dot.ld{background:var(--am);animation:pls .4s infinite}
.dot.er{background:var(--rd);animation:none}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.3}}
.tag{font-size:9px;padding:2px 6px;border-radius:3px;background:var(--acd);color:var(--ac);border:1px solid rgba(74,158,255,.2)}
.toast{position:absolute;top:58px;left:50%;transform:translateX(-50%);z-index:1001;padding:8px 16px;border-radius:5px;font-size:11px;backdrop-filter:blur(8px);display:none;max-width:500px;text-align:center}
.toast.e{background:rgba(229,80,80,.15);border:1px solid rgba(229,80,80,.3);color:#fca5a5}
.toast.i{background:rgba(74,158,255,.12);border:1px solid rgba(74,158,255,.25);color:#93c5fd}
.toast.w{background:rgba(240,168,48,.12);border:1px solid rgba(240,168,48,.25);color:#fcd34d}
.toast.show{display:block}
.mw{position:absolute;z-index:500;pointer-events:none;mix-blend-mode:screen}
.mw img{width:100%;height:100%;display:block}
.preset-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;margin-bottom:8px}
.preset-btn{font-family:inherit;font-size:9px;padding:4px 2px;border-radius:3px;border:1px solid transparent;background:var(--inp);color:var(--txd);cursor:pointer;text-align:center;transition:.12s}
.preset-btn:hover{border-color:var(--ac);color:var(--tx)}
.preset-btn.on{background:var(--acd);border-color:var(--ac);color:var(--ac);font-weight:600}
.blend-sel{font-family:inherit;font-size:10px;background:var(--inp);color:var(--tx);border:1px solid var(--bd);border-radius:4px;padding:3px 6px;outline:none;width:100%;margin-top:2px}
.blend-sel:focus{border-color:var(--ac)}
.leaflet-control-zoom a{background:var(--pn)!important;color:var(--tx)!important;border-color:var(--bd)!important}
.leaflet-control-zoom a:hover{background:var(--inp)!important}
.leaflet-control-attribution{background:rgba(7,11,20,.75)!important;color:var(--txm)!important;font-size:9px!important}
.leaflet-control-attribution a{color:var(--txd)!important}
.setup-overlay{position:fixed;inset:0;z-index:9999;background:rgba(7,11,20,.97);display:flex;align-items:center;justify-content:center;padding:20px}
.setup-box{background:var(--pn);border:1px solid var(--bd);border-radius:12px;padding:28px 32px;max-width:520px;width:100%}
.setup-box h2{font-size:18px;margin-bottom:12px;color:var(--ac)}
.setup-box p{font-size:13px;color:var(--txd);line-height:1.7;margin-bottom:10px}
.setup-box code{background:var(--inp);padding:2px 6px;border-radius:3px;font-size:12px;color:var(--am)}
.setup-box .cmd{background:var(--inp);padding:10px 14px;border-radius:6px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:12px;color:var(--am);margin:10px 0;word-break:break-all}
.setup-box button{margin-top:14px}
@media(max-width:768px){.sidebar{width:100%;top:auto;bottom:0;height:45vh;border-left:none;border-top:1px solid var(--bd)}.sidebar.hide{transform:translateY(100%)}.sbt{top:auto;bottom:45vh;right:8px;border-radius:5px 5px 0 0;border:1px solid var(--bd);border-bottom:none}.sbt.shifted{bottom:0}.brand-name{display:none}.topbar{gap:6px;padding:6px 8px}}
</style>
</head>
<body>
<!-- Setup instructions overlay (shown only when opened from file://) -->
<div class="setup-overlay" id="setupOverlay" style="display:none">
<div class="setup-box">
<h2>⚡ Quick Setup Required</h2>
<p>SPC images can't load when this file is opened directly from your device (file:// protocol). You need to serve it from a local web server. This takes 10 seconds:</p>
<p><b>Option 1 — Python (Mac/Linux/Windows):</b></p>
<div class="cmd">cd ~/Downloads && python3 -m http.server 8080</div>
<p>Then open <code>http://localhost:8080/spc-mesoanalysis-viewer.html</code></p>
<p><b>Option 2 — npx (if you have Node.js):</b></p>
<div class="cmd">npx serve ~/Downloads -p 8080</div>
<p><b>Option 3 — Upload to any web host</b> (GitHub Pages, Netlify, etc.)</p>
<p style="color:var(--txm);font-size:11px;margin-top:12px">Why? Browsers block cross-origin images from file:// for security. A local server makes it http:// which allows SPC images to load normally.</p>
<button class="btn btn-ac" onclick="document.getElementById('setupOverlay').style.display='none'">I understand, try anyway →</button>
</div>
</div>

<div class="topbar">
  <div class="brand"><div class="brand-mark">M</div><span class="brand-name">MesoViz</span></div>
  <div class="sep"></div>
  <div class="ctrl"><span class="ctrl-label">Date</span><input type="date" id="dateIn"></div>
  <div class="ctrl"><span class="ctrl-label">Hour (Z)</span>
    <div class="hnav">
      <button class="btn btn-i" onclick="step(-6)">⟨⟨</button>
      <button class="btn btn-i" onclick="step(-1)">⟨</button>
      <span class="hval" id="hv">18</span>
      <button class="btn btn-i" onclick="step(1)">⟩</button>
      <button class="btn btn-i" onclick="step(6)">⟩⟩</button>
    </div>
  </div>
  <div class="sep"></div>
  <button class="btn btn-ac" onclick="load()">Load</button>
  <button class="btn" onclick="goNow()">Now</button>
</div>
<button class="sbt" id="sbt" onclick="togSB()">◀</button>
<div class="sidebar" id="sb">
  <div class="sec">
    <div class="sh"><span class="sd"></span>Layers</div>
    <div class="row"><span class="rl">SPC Mesoanalysis</span><div class="sw on" id="swM" onclick="togMeso()"></div></div>
    <div class="sr"><span class="sl">Opacity</span><input type="range" min="0" max="100" value="75" id="mOp" oninput="smOp(this.value)"><span class="sv" id="mOpV">75%</span></div>
    <div class="row" style="margin-top:6px"><span class="rl">Radar (live only)</span><div class="sw" id="swR" onclick="togRadar()"></div></div>
    <div class="sr"><span class="sl">Opacity</span><input type="range" min="0" max="100" value="55" id="rOp" oninput="srOp(this.value)"><span class="sv" id="rOpV">55%</span></div>
    <div id="rn" style="font-size:9px;color:var(--txm);margin-top:4px;display:none"></div>
  </div>
  <div class="sec">
    <div class="sh"><span class="sd"></span>Image Filters</div>
    <div style="font-size:9px;color:var(--txm);margin-bottom:6px">Presets</div>
    <div class="preset-grid" id="presetGrid"></div>
    <div class="sr"><span class="sl">Hue</span><input type="range" min="0" max="360" value="0" id="fHue" oninput="uf()"><span class="sv" id="fHueV">0°</span></div>
    <div class="sr"><span class="sl">Saturate</span><input type="range" min="0" max="300" value="100" id="fSat" oninput="uf()"><span class="sv" id="fSatV">100%</span></div>
    <div class="sr"><span class="sl">Brightness</span><input type="range" min="30" max="250" value="100" id="fBri" oninput="uf()"><span class="sv" id="fBriV">100%</span></div>
    <div class="sr"><span class="sl">Contrast</span><input type="range" min="30" max="300" value="100" id="fCon" oninput="uf()"><span class="sv" id="fConV">100%</span></div>
    <div class="sr"><span class="sl">Invert</span><input type="range" min="0" max="100" value="0" id="fInv" oninput="uf()"><span class="sv" id="fInvV">0%</span></div>
    <div style="margin-top:6px"><span class="sl" style="font-size:10px;color:var(--txd)">Blend Mode</span>
    <select class="blend-sel" id="blendSel" onchange="ubm()">
      <option value="screen">Screen (default)</option>
      <option value="normal">Normal</option>
      <option value="lighten">Lighten</option>
      <option value="color-dodge">Color Dodge</option>
      <option value="overlay">Overlay</option>
      <option value="soft-light">Soft Light</option>
      <option value="hard-light">Hard Light</option>
      <option value="multiply">Multiply</option>
      <option value="luminosity">Luminosity</option>
      <option value="color">Color</option>
    </select></div>
  </div>
  <div class="sec"><div class="sh"><span class="sd"></span>Source</div><div style="font-size:10px;color:var(--txd);line-height:1.5;word-break:break-all" id="src">—</div></div>
  <div class="sec" style="max-height:calc(100vh - 340px);overflow-y:auto">
    <div class="sh"><span class="sd"></span>Parameters</div>
    <div class="pg" id="pg"></div>
  </div>
  <div class="sec">
    <div class="sh"><span class="sd"></span>Keys</div>
    <div style="font-size:9px;color:var(--txm);line-height:1.8">← → ±1h | Shift ±6h | R radar</div>
  </div>
  <div class="sec">
    <div class="sh"><span class="sd"></span>About</div>
    <div style="font-size:9px;color:var(--txm);line-height:1.6">
      <a href="https://www.spc.noaa.gov/exper/ma_archive/" target="_blank" style="color:var(--ac);text-decoration:none">SPC Archive</a> (May 2005–present) |
      <a href="https://www.rainviewer.com/api.html" target="_blank" style="color:var(--ac);text-decoration:none">RainViewer</a> (live)<br>
      <span style="color:var(--am)">Note:</span> Lambert Conformal Conic → Web Mercator; slight edge distortion.<br>
      <span style="color:var(--am)">Tip:</span> Must be served via HTTP (see setup instructions).
    </div>
  </div>
</div>
<div class="mw" id="mw" style="display:none"><img id="mi" src="" alt=""></div>
<div class="toast" id="toast"></div>
<div class="status">
  <div class="si"><span class="dot" id="sd2"></span><span id="st">Ready</span></div>
  <span id="co">—</span>
  <span class="tag" id="tp">sbcp</span>
</div>
<div id="map"></div>
<script>
const P={
"Thermodynamics":{sbcp:"SBCAPE",mlcp:"MLCAPE",mucp:"MUCAPE",dcape:"DCAPE",laps:"Mid-Lv Lapse",lllr:"Low-Lv Lapse",ncap:"NCAPE",mcsm:"MCS Maint"},
"Shear / Wind":{eshr:"Eff Shear",shr6:"0-6km Shear",shr8:"0-8km Shear",shr1:"0-1km Shear",brns:"BRN Shear",effh:"Eff SRH",srh5:"0-500m SRH",srh1:"0-1 SRH",srh3:"0-3 SRH",llsr:"0-2 SR Wind",mlsr:"4-6 SR Wind",ulsr:"6-9 SR Wind",alsr:"Anvil SR Wnd",mnwd:"Mean Wind"},
"Composite":{scp:"Supercell",lscp:"Left SC",stpc:"Sig Tor (Eff)",stor:"Sig Tor (Fix)",vtp:"Violent Tor",sigt:"Sig Hail",sars:"SARS Hail",lghl:"Lrg Hail",dcp:"Derecho",cbsig:"Crits Sig Svr",brn:"BRN",nst:"NonSC Tor",ep0:"P(EF0+)",ep2:"P(EF2+)",ep4:"P(EF4+)"},
"Upper Air":{"500mb":"500mb","300mb":"300mb","700mb":"700mb","850mb":"850mb","925mb":"925mb",ttd:"Sfc T/Td/Wind",ageo:"300 Circ",dpva:"DPVA"},
"Surface":{pmsl:"MSL Press",pchg:"2hr P Chg",thea:"Theta-E Adv",mcon:"Moist Conv",sfnt:"Sfc FGEN","8fnt":"850 FGEN"},
"Moisture":{dwpt:"Sfc Dwpt",pwat:"PWAT",tpwt:"PWAT Transport"},
"Forcing":{lclh:"LCL Height",lfch:"LFC Height",dlcp:"Deep Moist Conv"}
};

const SW=[20.0,-121.0],NE=[51.5,-63.5];
let map,rL,rD,cP='sbcp',cH=18,mOn=true,rOn=false,mOp=.75,rOp=.55,iL=false;
const p2=n=>String(n).padStart(2,'0');
function gD(){const v=document.getElementById('dateIn').value.split('-');return new Date(+v[0],+v[1]-1,+v[2])}
function isCur(d,h){return Math.abs(new Date()-new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),h)))/36e5<=3}
function isRec(d,h){const df=(new Date()-new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),h)))/36e5;return df>=-1&&df<=78}

function uRT(d,h,p){return`https://www.spc.noaa.gov/exper/mesoanalysis/s19/${p}/${p}_${String(d.getFullYear()).slice(-2)}${p2(d.getMonth()+1)}${p2(d.getDate())}${p2(h)}.gif`}
function uAR(d,h,p){return`https://www.spc.noaa.gov/exper/ma_archive/images_s4/${d.getFullYear()}${p2(d.getMonth()+1)}${p2(d.getDate())}/${p2(h)}/${p}.gif`}

function initMap(){
  map=L.map('map',{center:[38.5,-96],zoom:5,minZoom:3,maxZoom:12});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains:'abcd',maxZoom:19
  }).addTo(map);
  map.on('mousemove',e=>{document.getElementById('co').textContent=`${e.latlng.lat.toFixed(2)}°, ${e.latlng.lng.toFixed(2)}°`});
  map.on('move',sync);map.on('zoom',sync);map.on('resize',sync);
}

function sync(){
  if(!iL||!mOn)return;
  const w=document.getElementById('mw'),sp=map.latLngToContainerPoint(SW),np=map.latLngToContainerPoint(NE);
  w.style.left=Math.min(sp.x,np.x)+'px';w.style.top=Math.min(sp.y,np.y)+'px';
  w.style.width=Math.abs(np.x-sp.x)+'px';w.style.height=Math.abs(np.y-sp.y)+'px';
  w.style.display='block';w.style.opacity=mOp;
}
function hide(){document.getElementById('mw').style.display='none'}

function load(){
  const d=gD(),h=cH,ds=document.getElementById('dateIn').value;
  const rec=isRec(d,h);
  const u1=rec?uRT(d,h,cP):uAR(d,h,cP);
  const u2=rec?uAR(d,h,cP):uRT(d,h,cP);
  const s1=rec?'real-time':'archive',s2=rec?'archive':'real-time';
  ss('ld',`Loading ${cP} — ${ds} ${p2(h)}Z...`);
  document.getElementById('src').textContent=`Trying ${s1}...`;
  iL=false;hide();
  const img=document.getElementById('mi');
  img.onload=()=>{iL=true;sync();
    document.getElementById('src').innerHTML=`<span style="color:var(--gn)">✓</span> <b>${s1}</b><br><span style="font-size:8px">${u1}</span>`;
    ss('ok',`${cP} — ${ds} ${p2(h)}Z`);};
  img.onerror=()=>{
    document.getElementById('src').textContent=`Trying ${s2}...`;
    img.onload=()=>{iL=true;sync();
      document.getElementById('src').innerHTML=`<span style="color:var(--gn)">✓</span> <b>${s2}</b> (fallback)<br><span style="font-size:8px">${u2}</span>`;
      ss('ok',`${cP} — ${ds} ${p2(h)}Z`);};
    img.onerror=()=>{
      document.getElementById('src').innerHTML=`<span style="color:var(--rd)">✗</span> Not available<br><span style="font-size:8px">${u1}<br>${u2}</span>`;
      ss('er','Not available');
      if(location.protocol==='file:')sT('w','Images blocked — must serve via HTTP. See setup instructions.');
      else sT('e','Image not found for this date/time.');};
    img.src=u2;};
  img.src=u1;
  upR(d,h);document.getElementById('tp').textContent=cP;
}

async function fR(){try{const r=await fetch('https://api.rainviewer.com/public/weather-maps.json');rD=await r.json()}catch(e){}}
function shR(){if(!rD||rL)return;const f=rD.radar.past,l=f[f.length-1];rL=L.tileLayer(rD.host+l.path+'/256/{z}/{x}/{y}/6/1_1.png',{tileSize:256,opacity:rOp,zIndex:100}).addTo(map)}
function hiR(){if(rL){map.removeLayer(rL);rL=null}}
function upR(d,h){const c=isCur(d,h),n=document.getElementById('rn');
  if(!c){hiR();rOn=false;document.getElementById('swR').classList.remove('on');n.style.display='block';n.textContent='⚠ Radar disabled — historical data.'}
  else{if(rOn){shR();n.style.display='none'}else n.style.display='none'}}

function step(d){cH=((cH+d)%24+24)%24;document.getElementById('hv').textContent=p2(cH);load()}
function goNow(){const n=new Date(),u=n.getUTCHours(),h=((u-2)+24)%24;
  let d=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()));
  if(u<2)d.setUTCDate(d.getUTCDate()-1);
  document.getElementById('dateIn').value=`${d.getUTCFullYear()}-${p2(d.getUTCMonth()+1)}-${p2(d.getUTCDate())}`;
  cH=h;document.getElementById('hv').textContent=p2(cH);load()}
function togMeso(){mOn=!mOn;document.getElementById('swM').classList.toggle('on',mOn);if(mOn&&iL)sync();else hide()}
function togRadar(){if(!isCur(gD(),cH)){sT('i','Radar only available for current conditions. Press "Now".');return}
  rOn=!rOn;document.getElementById('swR').classList.toggle('on',rOn);rOn?shR():hiR()}
function smOp(v){mOp=v/100;document.getElementById('mOpV').textContent=v+'%';if(iL)document.getElementById('mw').style.opacity=mOp}
function srOp(v){rOp=v/100;document.getElementById('rOpV').textContent=v+'%';if(rL)rL.setOpacity(rOp)}
function togSB(){const s=document.getElementById('sb'),b=document.getElementById('sbt');
  s.classList.toggle('hide');b.classList.toggle('shifted');b.textContent=s.classList.contains('hide')?'▶':'◀';
  setTimeout(()=>{map.invalidateSize();sync()},350)}
function bP(){const g=document.getElementById('pg');
  for(const[cat,ps]of Object.entries(P)){
    const h=document.createElement('div');h.className='cat';h.textContent=cat;g.appendChild(h);
    for(const[k,l]of Object.entries(ps)){
      const b=document.createElement('button');b.className='pb'+(k===cP?' on':'');
      b.textContent=l;b.title=k;b.dataset.p=k;
      b.onclick=()=>{cP=k;document.querySelectorAll('.pb').forEach(x=>x.classList.toggle('on',x.dataset.p===k));load()};
      g.appendChild(b)}}}
function ss(t,m){document.getElementById('sd2').className='dot'+(t==='ld'?' ld':t==='er'?' er':'');document.getElementById('st').textContent=m}
let tT;function sT(t,m){const e=document.getElementById('toast');e.className='toast '+t+' show';e.textContent=m;clearTimeout(tT);tT=setTimeout(()=>e.classList.remove('show'),6000)}

// === Image Filters ===
const PRESETS=[
  {name:'Default',hue:0,sat:100,bri:100,con:100,inv:0,blend:'screen'},
  {name:'Cool Blue',hue:200,sat:160,bri:110,con:120,inv:0,blend:'screen'},
  {name:'Warm',hue:30,sat:140,bri:105,con:115,inv:0,blend:'screen'},
  {name:'Fire',hue:340,sat:180,bri:110,con:130,inv:0,blend:'color-dodge'},
  {name:'Neon',hue:90,sat:250,bri:120,con:140,inv:0,blend:'screen'},
  {name:'Inverted',hue:180,sat:100,bri:100,con:110,inv:100,blend:'normal'},
  {name:'Muted',hue:0,sat:40,bri:110,con:90,inv:0,blend:'screen'},
  {name:'Purple',hue:270,sat:160,bri:105,con:120,inv:0,blend:'screen'},
  {name:'High Con',hue:0,sat:120,bri:105,con:200,inv:0,blend:'screen'},
];
let curPreset=0;
function bPresets(){const g=document.getElementById('presetGrid');
  PRESETS.forEach((p,i)=>{const b=document.createElement('button');b.className='preset-btn'+(i===0?' on':'');
  b.textContent=p.name;b.dataset.i=i;b.onclick=()=>applyPreset(i);g.appendChild(b)})}
function applyPreset(i){
  const p=PRESETS[i];curPreset=i;
  document.getElementById('fHue').value=p.hue;
  document.getElementById('fSat').value=p.sat;
  document.getElementById('fBri').value=p.bri;
  document.getElementById('fCon').value=p.con;
  document.getElementById('fInv').value=p.inv;
  document.getElementById('blendSel').value=p.blend;
  document.querySelectorAll('.preset-btn').forEach((b,j)=>b.classList.toggle('on',j===i));
  uf();ubm();
}
function uf(){
  const h=document.getElementById('fHue').value,s=document.getElementById('fSat').value,
    b=document.getElementById('fBri').value,c=document.getElementById('fCon').value,
    v=document.getElementById('fInv').value;
  document.getElementById('fHueV').textContent=h+'°';
  document.getElementById('fSatV').textContent=s+'%';
  document.getElementById('fBriV').textContent=b+'%';
  document.getElementById('fConV').textContent=c+'%';
  document.getElementById('fInvV').textContent=v+'%';
  document.getElementById('mi').style.filter=
    `hue-rotate(${h}deg) saturate(${s}%) brightness(${b}%) contrast(${c}%) invert(${v}%)`;
  // Deselect preset if user manually changed values
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('on'));
}
function ubm(){document.getElementById('mw').style.mixBlendMode=document.getElementById('blendSel').value}

document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
  if(e.key==='ArrowLeft'||e.key===','){e.preventDefault();step(e.shiftKey?-6:-1)}
  else if(e.key==='ArrowRight'||e.key==='.'){e.preventDefault();step(e.shiftKey?6:1)}
  else if(e.key==='r'||e.key==='R')togRadar()});

document.addEventListener('DOMContentLoaded',()=>{
  // Detect file:// protocol and show setup instructions
  if(location.protocol==='file:'){
    document.getElementById('setupOverlay').style.display='flex';
  }
  const y=new Date();y.setDate(y.getDate()-1);
  document.getElementById('dateIn').value=`${y.getFullYear()}-${p2(y.getMonth()+1)}-${p2(y.getDate())}`;
  initMap();bP();bPresets();fR();setTimeout(load,400)});
</script>
</body>
</html>
